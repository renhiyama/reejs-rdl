/* esm.sh - esbuild bundle(@web3-storage/multipart-parser@1.0.0) node production */
function y(i){let e=unescape(encodeURIComponent(i));return Uint8Array.from(e,(n,r)=>e.charCodeAt(r))}function b(i){let e=String.fromCharCode.apply(null,i);return decodeURIComponent(escape(e))}function p(...i){let e=new Uint8Array(i.reduce((r,t)=>r+t.length,0)),n=0;for(let r of i)e.set(r,n),n+=r.length;return e}function C(i,e){if(i.length!==e.length)return!1;for(let n=0;n<i.length;n++)if(i[n]!==e[n])return!1;return!0}function x(i){return i instanceof Uint8Array?e=>i[e]:i}function A(i,e,n,r,t){let o=x(i),s=x(n);for(let h=0;h<t;++h)if(o(e+h)!==s(r+h))return!1;return!0}function U(i){let e=new Array(256).fill(i.length);if(i.length>1)for(let n=0;n<i.length-1;n++)e[i[n]]=i.length-1-n;return e}var c=Symbol("Match"),m=class{constructor(e){this._lookbehind=new Uint8Array,typeof e=="string"?this._needle=e=y(e):this._needle=e,this._lastChar=e[e.length-1],this._occ=U(e)}feed(e){let n=0,r,t=[];for(;n!==e.length;)[n,...r]=this._feed(e,n),t.push(...r);return t}end(){let e=this._lookbehind;return this._lookbehind=new Uint8Array,e}_feed(e,n){let r=[],t=-this._lookbehind.length;if(t<0){for(;t<0&&t<=e.length-this._needle.length;){let o=this._charAt(e,t+this._needle.length-1);if(o===this._lastChar&&this._memcmp(e,t,this._needle.length-1))return t>-this._lookbehind.length&&r.push(this._lookbehind.slice(0,this._lookbehind.length+t)),r.push(c),this._lookbehind=new Uint8Array,[t+this._needle.length,...r];t+=this._occ[o]}if(t<0)for(;t<0&&!this._memcmp(e,t,e.length-t);)t++;if(t>=0)r.push(this._lookbehind),this._lookbehind=new Uint8Array;else{let o=this._lookbehind.length+t;return o>0&&(r.push(this._lookbehind.slice(0,o)),this._lookbehind=this._lookbehind.slice(o)),this._lookbehind=Uint8Array.from(new Array(this._lookbehind.length+e.length),(s,h)=>this._charAt(e,h-this._lookbehind.length)),[e.length,...r]}}for(t+=n;t<=e.length-this._needle.length;){let o=e[t+this._needle.length-1];if(o===this._lastChar&&e[t]===this._needle[0]&&A(this._needle,0,e,t,this._needle.length-1))return t>n&&r.push(e.slice(n,t)),r.push(c),[t+this._needle.length,...r];t+=this._occ[o]}if(t<e.length){for(;t<e.length&&(e[t]!==this._needle[0]||!A(e,t,this._needle,0,e.length-t));)++t;t<e.length&&(this._lookbehind=e.slice(t))}return t>0&&r.push(e.slice(n,t<e.length?t:e.length)),[e.length,...r]}_charAt(e,n){return n<0?this._lookbehind[this._lookbehind.length+n]:e[n]}_memcmp(e,n,r){return A(this._charAt.bind(this,e),n,this._needle,0,r)}},k=class{constructor(e,n){this._readableStream=n,this._search=new m(e)}async*[Symbol.asyncIterator](){let e=this._readableStream.getReader();try{for(;;){let r=await e.read();if(r.done)break;yield*this._search.feed(r.value)}let n=this._search.end();n.length&&(yield n)}finally{e.releaseLock()}}},E=Symbol("End of Queue"),S=class{constructor(e){this._chunksQueue=[],this._closed=!1,this._search=new m(e)}push(...e){if(this._closed)throw new Error("cannot call push after close");this._chunksQueue.push(...e),this._notify&&this._notify()}close(){if(this._closed)throw new Error("close was already called");this._closed=!0,this._chunksQueue.push(E),this._notify&&this._notify()}async*[Symbol.asyncIterator](){for(;;){let n;for(;!(n=this._chunksQueue.shift());)await new Promise(r=>this._notify=r),this._notify=void 0;if(n===E)break;yield*this._search.feed(n)}let e=this._search.end();e.length&&(yield e)}};var I=Function.prototype.apply.bind(p,void 0),T=y("--"),_=y(`\r
`);function L(i){let e=i.split(";").map(r=>r.trim());if(e.shift()!=="form-data")throw new Error('malformed content-disposition header: missing "form-data" in `'+JSON.stringify(e)+"`");let n={};for(let r of e){let t=r.split("=",2);if(t.length!==2)throw new Error("malformed content-disposition header: key-value pair not found - "+r+" in `"+i+"`");let[o,s]=t;if(s[0]==='"'&&s[s.length-1]==='"')n[o]=s.slice(1,-1).replace(/\\"/g,'"');else if(s[0]!=='"'&&s[s.length-1]!=='"')n[o]=s;else if(s[0]==='"'&&s[s.length-1]!=='"'||s[0]!=='"'&&s[s.length-1]==='"')throw new Error("malformed content-disposition header: mismatched quotations in `"+i+"`")}if(!n.name)throw new Error("malformed content-disposition header: missing field name in `"+i+"`");return n}function M(i){let e=[],n=!1,r;for(;typeof(r=i.shift())<"u";){let t=r.indexOf(":");if(t===-1)throw new Error("malformed multipart-form header: missing colon");let o=r.slice(0,t).trim().toLowerCase(),s=r.slice(t+1).trim();switch(o){case"content-disposition":n=!0,e.push(...Object.entries(L(s)));break;case"content-type":e.push(["contentType",s])}}if(!n)throw new Error("malformed multipart-form header: missing content-disposition");return Object.fromEntries(e)}async function O(i,e){let n=!0,r=!1,t=[[]],o=new m(_);for(;;){let s=await i.next();if(s.done)throw new Error("malformed multipart-form data: unexpected end of stream");if(n&&s.value!==c&&C(s.value.slice(0,2),T))return[void 0,new Uint8Array];let h;if(s.value!==c)h=s.value;else if(!r)h=e;else throw new Error("malformed multipart-form data: unexpected boundary");if(!h.length)continue;n&&(n=!1);let f=o.feed(h);for(let[w,a]of f.entries()){let g=a===c;if(!(!g&&!a.length)){if(r&&g)return f.push(o.end()),[t.filter(u=>u.length).map(I).map(b),p(...f.slice(w+1).map(u=>u===c?_:u))];(r=g)?t.push([]):t[t.length-1].push(a)}}}}async function*Q(i,e){let n=p(T,y(e)),r=new k(n,i)[Symbol.asyncIterator]();for(;;){let o=await r.next();if(o.done)return;if(o.value===c)break}let t=new m(_);for(;;){let w=function(l){let d=[];for(let v of t.feed(l))f&&d.push(_),(f=v===c)||d.push(v);return p(...d)},[o,s]=await O(r,n);if(!o)return;async function h(){let l=await r.next();if(l.done)throw new Error("malformed multipart-form data: unexpected end of stream");return l}let f=!1,a=!1;async function g(){let l=await h(),d;if(l.value!==c)d=l.value;else if(!f)d=_;else return a=!0,{value:t.end()};return{value:w(d)}}let u=[{value:w(s)}];for(yield{...M(o),data:{[Symbol.asyncIterator](){return this},async next(){for(;;){let l=u.shift();if(!l)break;if(l.value.length>0)return l}for(;;){if(a)return{done:a,value:void 0};let l=await g();if(l.value.length>0)return l}}}};!a;)u.push(await g())}}async function*D(i,e){for await(let n of Q(i,e)){let r=[];for await(let t of n.data)r.push(t);yield{...n,data:p(...r)}}}export{D as iterateMultipart,Q as streamMultipart};
//# sourceMappingURL=multipart-parser.mjs.map